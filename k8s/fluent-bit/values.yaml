config:
  ## https://docs.fluentbit.io/manual/pipeline/outputs
  outputs: |
    [OUTPUT]
        name                   loki
        host                   loki-gateway.loki.svc.cluster.local
        port                   80
        match                  *
        labels                 host=$kubernetes['host'],namespace=$kubernetes['namespace_name'],app=$kubernetes['labels']['app'],pod_name=$kubernetes['pod_name'],container_name=$kubernetes['container_name']
        tenant_id              fluent-bit
  filters: |
    [FILTER]
        name                   kubernetes
        match                  kube.*
        merge_log              on
        keep_log               off
        k8s-logging.parser     on
        k8s-logging.exclude    on
        annotations            off
        buffer_size            2MB

    [FILTER]
        name                   lua
        match                  kube.*
        script                 /fluent-bit/scripts/serilog_filter.lua
        call                   process_serilog
  customParsers: |
    [PARSER]
        name                   serilog-formatting-compact
        format                 json
        time_key               @t
        time_format            %Y-%m-%dT%H:%M:%S.%L%z
        time_strict            true
        time_keep              true # Keep the original time field for serilog filter
        # Optional: If the log level is present as a short string, map it
        types                  @l:string @m:string @x:string
luaScripts:
  serilog_filter.lua: |
    -- Lua filter for serilog-formatting-compact parsed logs
    -- Only processes records that have serilog-specific fields (@t, @m, @l)
    function process_serilog(tag, timestamp, record)
        -- Check if this is a serilog-formatted log (has @t or @m fields)
        if record["@t"] == nil and record["@m"] == nil then
            -- Not a serilog log, pass through unchanged
            return 0, timestamp, record
        end

        -- Remove @t
        record["@t"] = nil

        -- Example: Map serilog fields to standard field names
        if record["@m"] then
            record["message"] = record["@m"]
            record["@m"] = nil  -- Optionally remove the original field
        end

        if record["@l"] then
            -- Map serilog log level to loki level
            local level_map = {
              ["Verbose"] = "trace",
              ["Debug"] = "debug",
              ["Information"] = "info",
              ["Warning"] = "warn",
              ["Error"] = "error",
              ["Fatal"] = "critical"
            }
            if level_map[record["@l"]] then
              record["level"] = level_map[record["@l"]]
            else
              record["level"] = "unknown"
            end

            record["@l"] = nil  -- Optionally remove the original field
        else
            record["level"] = "info"  -- Default level if not present
        end


        if record["@x"] then
            record["exception"] = record["@x"]
            record["@x"] = nil  -- Optionally remove the original field
        end

        -- Return modified record (1 = modified, 0 = unchanged, -1 = drop)
        return 1, timestamp, record
    end
