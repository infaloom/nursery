"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[3945],{7798:(e,s,o)=>{o.r(s),o.d(s,{assets:()=>c,contentTitle:()=>i,default:()=>l,frontMatter:()=>r,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"storage/ceph-dashboard-sso","title":"Ceph Dashboard SSO","description":"This step is optional. It shows how to enable SAML2 SSO in Ceph Dashboard using Keycloak as Identity Provider.","source":"@site/docs/80-storage/20-ceph-dashboard-sso.md","sourceDirName":"80-storage","slug":"/storage/ceph-dashboard-sso","permalink":"/nursery/storage/ceph-dashboard-sso","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/80-storage/20-ceph-dashboard-sso.md","tags":[],"version":"current","sidebarPosition":20,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Rook Ceph Setup","permalink":"/nursery/storage/rook-ceph"},"next":{"title":"Logging","permalink":"/nursery/logging/"}}');var t=o(4848),n=o(8453);const r={},i="Ceph Dashboard SSO",c={},d=[{value:"Setup Ceph Dashboard SSO with Keycloak",id:"setup-ceph-dashboard-sso-with-keycloak",level:2},{value:"Create admin user for SAML2 SSO",id:"create-admin-user-for-saml2-sso",level:2},{value:"Configure Keycloak SAML2 client",id:"configure-keycloak-saml2-client",level:2}];function h(e){const s={admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,n.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"ceph-dashboard-sso",children:"Ceph Dashboard SSO"})}),"\n",(0,t.jsx)(s.p,{children:"This step is optional. It shows how to enable SAML2 SSO in Ceph Dashboard using Keycloak as Identity Provider."}),"\n",(0,t.jsx)(s.h2,{id:"setup-ceph-dashboard-sso-with-keycloak",children:"Setup Ceph Dashboard SSO with Keycloak"}),"\n",(0,t.jsxs)(s.p,{children:["Download the IdP metadata from Keycloak. We are using the ",(0,t.jsx)(s.code,{children:"nursery"})," realm created in the Keycloak setup guide."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'curl -o descriptor.xml -L "https://account.${CLUSTER_DOMAIN}/realms/nursery/protocol/saml/descriptor"\n'})}),"\n",(0,t.jsx)(s.p,{children:"Set WantAuthnRequestsSigned to false. I couldn't get it working with signing enabled. But given that the communication is done over HTTPS, it should be secure enough."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'sed -i \'s/WantAuthnRequestsSigned="true"/WantAuthnRequestsSigned="false"/\' descriptor.xml\n'})}),"\n",(0,t.jsx)(s.p,{children:"Copy descriptor.xml to Ceph Manager pod"}),"\n",(0,t.jsxs)(s.admonition,{type:"note",children:[(0,t.jsx)(s.p,{children:"It could be that the active Ceph Manager pod is not the one with ceph_daemon_id=a. In that case, find the active pod with the following command and copy the file to that pod instead."}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- ceph mgr dump | grep active_name\n"})})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl cp descriptor.xml $(kubectl get pods -n rook-ceph -l app=rook-ceph-mgr,ceph_daemon_id=a -o jsonpath='{.items[0].metadata.name}'):/tmp/descriptor.xml -n rook-ceph -c mgr\n"})}),"\n",(0,t.jsx)(s.p,{children:"Enable SAML2 SSO in Ceph Dashboard"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- ceph dashboard sso setup saml2 https://ceph-dashboard.${CLUSTER_DOMAIN} file:///tmp/descriptor.xml username\n"})}),"\n",(0,t.jsx)(s.p,{children:"Disable redirection to avoid infinite redirect loop when SSO is not working"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- ceph config set mgr mgr/dashboard/standby_behaviour "error"\n'})}),"\n",(0,t.jsx)(s.h2,{id:"create-admin-user-for-saml2-sso",children:"Create admin user for SAML2 SSO"}),"\n",(0,t.jsx)(s.p,{children:"The password will be randomly generated and stored in a temporary file inside the pod. After creating the user, the temporary file will be deleted.\r\nThe password isn't necessary because user authentication will be done via Keycloak, but Ceph Dashboard requires password when creating a user."}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["You need to change ",(0,t.jsx)(s.code,{children:"{USERNAME}"})," to the username of the Keycloak user you plan to use for accessing Ceph Dashboard."]})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- bash -c "echo $(openssl rand -base64 32) > /tmp/pass"\r\nkubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- ceph dashboard ac-user-create {USERNAME} administrator -i /tmp/pass\r\nkubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- bash -c "rm /tmp/pass"\n'})}),"\n",(0,t.jsx)(s.h2,{id:"configure-keycloak-saml2-client",children:"Configure Keycloak SAML2 client"}),"\n",(0,t.jsx)(s.p,{children:"Download the Service Provider metadata from Ceph Dashboard"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'curl -o sp-metadata.xml -L "https://ceph-dashboard.${CLUSTER_DOMAIN}/auth/saml2/metadata"\n'})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Import the ",(0,t.jsx)(s.code,{children:"sp-metadata.xml"})," file to Keycloak as new SAML2 client in the nursery realm."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"username"})," attribute mapping should be set to ",(0,t.jsx)(s.code,{children:"username"}),". The attribute is created automatically after importing the metadata but the mapping is not set by default."]}),"\n"]})]})}function l(e={}){const{wrapper:s}={...(0,n.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,s,o)=>{o.d(s,{R:()=>r,x:()=>i});var a=o(6540);const t={},n=a.createContext(t);function r(e){const s=a.useContext(n);return a.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),a.createElement(n.Provider,{value:s},e.children)}}}]);