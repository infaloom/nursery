"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[148],{4795:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"provisioning-the-cloud-resources/index","title":"Provision the cloud resources","description":"As a convenience, there is a script to export pulumi working dir and the passphrase.","source":"@site/docs/30-provisioning-the-cloud-resources/index.md","sourceDirName":"30-provisioning-the-cloud-resources","slug":"/provisioning-the-cloud-resources/","permalink":"/nursery/provisioning-the-cloud-resources/","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/30-provisioning-the-cloud-resources/index.md","tags":[],"version":"current","frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Getting Started","permalink":"/nursery/getting-started/"},"next":{"title":"Environment Variables","permalink":"/nursery/k3s/environment-variables"}}');var o=n(4848),t=n(8453);const i={},c="Provision the cloud resources",a={},l=[];function d(e){const s={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(s.header,{children:(0,o.jsx)(s.h1,{id:"provision-the-cloud-resources",children:"Provision the cloud resources"})}),"\n",(0,o.jsxs)(s.admonition,{type:"info",children:[(0,o.jsx)(s.p,{children:"As a convenience, there is a script to export pulumi working dir and the passphrase."}),(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"source scripts/export_pulumi_env.sh\n"})}),(0,o.jsx)(s.p,{children:"You can execute the above command every time you open a new terminal session to set the environment variables."}),(0,o.jsxs)(s.p,{children:["If you come across ",(0,o.jsx)(s.code,{children:"command not found"})," due to line endings on WSL, you can convert the script to use Unix line endings with the following command:"]}),(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"sudo apt-get install dos2unix\n"})}),(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"dos2unix scripts/export_pulumi_env.sh\n"})}),(0,o.jsx)(s.p,{children:"You can also set the environment variables manually as shown below."})]}),"\n",(0,o.jsx)(s.p,{children:"Export pulumi working directory"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"export PULUMI_CWD=$PWD/pulumi/hetzner/\n"})}),"\n",(0,o.jsx)(s.p,{children:"Export pulumi passphrase. Type a strong passphrase, 16 or more characters long, and press enter."}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"export PULUMI_CONFIG_PASSPHRASE=$(read -s; echo $REPLY)\n"})}),"\n",(0,o.jsx)(s.h1,{id:"provision-the-hetzner-cloud-resources",children:"Provision the Hetzner cloud resources"}),"\n",(0,o.jsxs)(s.p,{children:["Run the following commands, ",(0,o.jsx)(s.strong,{children:"ONCE"}),", after initial git clone.\nNote that we are using a local backend for pulumi, to avoid dependency on cloud providers.\nIdeally, you would use a cloud provider to store the state, but, we are using a local backend which you can safely commit to the repository because all the secrets are encrypted."]}),"\n",(0,o.jsx)(s.p,{children:"Install pulumi packages"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"pulumi --cwd $PULUMI_CWD install\n"})}),"\n",(0,o.jsx)(s.p,{children:"Login to pulumi with a local backend"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"pulumi --cwd $PULUMI_CWD login file://$PULUMI_CWD\n"})}),"\n",(0,o.jsx)(s.p,{children:"Create stack with a passphrase."}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"pulumi --cwd $PULUMI_CWD stack init production --secrets-provider=passphrase\n"})}),"\n",(0,o.jsxs)(s.p,{children:["Go to ",(0,o.jsx)(s.a,{href:"https://console.hetzner.com/projects",children:"https://console.hetzner.com/projects"})," and create a new project.",(0,o.jsx)(s.br,{}),"\n","Go to Security -> API Tokens and create a new token with ",(0,o.jsx)(s.code,{children:"Read & Write"})," permissions."]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"pulumi --cwd $PULUMI_CWD config set --secret hcloud:token {REPLACE_WITH_YOUR_HETZNER_CLOUD_TOKEN}\n"})}),"\n",(0,o.jsx)(s.p,{children:"Set the path to the ssh public key to use for the servers.\nThis public key will be used to access the servers. So make sure you have local ssh client setup with the corresponding private key"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:'pulumi --cwd $PULUMI_CWD config set --secret ssh:defaultSshPublicKeyPath "{REPLACE_WITH_YOUR_SSH_PUBLIC_KEY_PATH}"\n'})}),"\n",(0,o.jsx)(s.p,{children:"Set the IPv4 address you will use to manage the cluster. This is important step for security.\nBy default, this infrastructure will allow access to ssh port on servers only from this address.\nHere is a handy command. But you can also set the IP manually."}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"pulumi --cwd $PULUMI_CWD config set --secret ssh:sourceIp $(curl ifconfig.me)\n"})}),"\n",(0,o.jsx)(s.admonition,{type:"warning",children:(0,o.jsxs)(s.p,{children:[(0,o.jsx)(s.strong,{children:"We assume your your IP address is static."})," If your IP address changes, you'll need to re-run multiple commands to update the firewall rules, this is not covered in this guide."]})}),"\n",(0,o.jsx)(s.p,{children:"Create infrastructure with the following command"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"pulumi --cwd $PULUMI_CWD up\n"})}),"\n",(0,o.jsxs)(s.p,{children:["You may need to run ",(0,o.jsx)(s.code,{children:"pulumi --cwd $PULUMI_CWD up"})," multiple times, depending on the resource availability in the Hetzner cloud."]})]})}function u(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>c});var r=n(6540);const o={},t=r.createContext(o);function i(e){const s=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(t.Provider,{value:s},e.children)}}}]);