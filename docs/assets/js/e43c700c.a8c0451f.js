"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[3676],{3022:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>i,contentTitle:()=>c,default:()=>d,frontMatter:()=>t,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"harbor/harbor-setup","title":"Harbor Setup","description":"https://goharbor.io/","source":"@site/docs/120-harbor/10-harbor-setup.md","sourceDirName":"120-harbor","slug":"/harbor/harbor-setup","permalink":"/nursery/harbor/harbor-setup","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/120-harbor/10-harbor-setup.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Redis","permalink":"/nursery/redis/"},"next":{"title":"Harbor SSO","permalink":"/nursery/harbor/harbor-sso"}}');var a=s(4848),o=s(8453);const t={},c="Harbor Setup",i={},l=[{value:"Create external secrets",id:"create-external-secrets",level:2},{value:"Install",id:"install",level:2},{value:"Accessing Harbor",id:"accessing-harbor",level:2},{value:"Pulling an image from the registry",id:"pulling-an-image-from-the-registry",level:2}];function h(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.header,{children:(0,a.jsx)(r.h1,{id:"harbor-setup",children:"Harbor Setup"})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.a,{href:"https://goharbor.io/",children:"https://goharbor.io/"})}),"\n",(0,a.jsx)(r.p,{children:"Harbor is an open-source container image registry that secures images with role-based access control, scans images for vulnerabilities, signs images as trusted, etc."}),"\n",(0,a.jsx)(r.h2,{id:"create-external-secrets",children:"Create external secrets"}),"\n",(0,a.jsx)(r.p,{children:"Create OpenBao secret with a random password for Harbor admin user"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao kv put -mount=kv harbor-admin-password \\\n    HARBOR_ADMIN_PASSWORD=$(openssl rand -base64 32)\n"})}),"\n",(0,a.jsx)(r.p,{children:"Create namespace"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl create namespace harbor\n"})}),"\n",(0,a.jsx)(r.p,{children:"Create ExternalSecret to pull the password into k8s"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/harbor/harbor-admin-password-external-secret.yaml\n"})}),"\n",(0,a.jsx)(r.p,{children:"Create ExternalSecret to pull the cnpg password"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/harbor/harbor-cnpg-password-external-secret.yaml\n"})}),"\n",(0,a.jsx)(r.h2,{id:"install",children:"Install"}),"\n",(0,a.jsxs)(r.p,{children:["By default the harbor is configured to be served from ",(0,a.jsx)(r.code,{children:"https://harbor.${CLUSTER_DOMAIN}"})," but you can change it in the ",(0,a.jsx)(r.code,{children:"k8s/harbor/values.yaml"})," file."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"export CLUSTER_DOMAIN=$(pulumi --cwd $PULUMI_CWD config get cluster:domain)\n"})}),"\n",(0,a.jsx)(r.p,{children:"It will be accessable from the ssh source IP address you set in the pulumi config."}),"\n",(0,a.jsx)(r.admonition,{type:"warning",children:(0,a.jsx)(r.p,{children:"Harbor has issues with Redis Sentinel support at the time of writing.\nWe are using the Harbor helm chart built-in redis instance."})}),"\n",(0,a.jsx)(r.p,{children:"Create registry database in the PostgreSQL cluster"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:'kubectl --namespace cnpg-system exec --stdin --tty services/cnpg-cluster-rw -- psql -c "CREATE DATABASE registry"\n'})}),"\n",(0,a.jsx)(r.p,{children:"Add helm repo"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"helm repo add harbor https://helm.goharbor.io\n"})}),"\n",(0,a.jsx)(r.p,{children:"Install Harbor with Helm"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"envsubst < k8s/harbor/harbor-values.yaml | \\\nhelm upgrade --install harbor harbor/harbor \\\n--version 1.16.2 \\\n--namespace harbor --create-namespace \\\n--values -\n"})}),"\n",(0,a.jsx)(r.h2,{id:"accessing-harbor",children:"Accessing Harbor"}),"\n",(0,a.jsx)(r.p,{children:"Run the following to get instructions to access Harbor UI"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:'echo "---- Harbor Access Instructions ----"\necho "Harbor url: https://$(kubectl --namespace harbor get ingress harbor-ingress -n harbor -o jsonpath=\'{.spec.rules[0].host}\')"\necho "Username: admin"\necho "Password: $(kubectl get secret harbor-admin-password -n harbor -o jsonpath="{.data.HARBOR_ADMIN_PASSWORD}" | base64 --decode)"\necho "------------------------------------"\n'})}),"\n",(0,a.jsx)(r.h2,{id:"pulling-an-image-from-the-registry",children:"Pulling an image from the registry"}),"\n",(0,a.jsxs)(r.p,{children:["Update the robot prefix to ",(0,a.jsx)(r.code,{children:"robot-"})," to avoid bash issues with ",(0,a.jsx)(r.code,{children:"robot$"})," using the harbor API:"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:'curl -X PUT "https://harbor.${CLUSTER_DOMAIN}/api/v2.0/configurations" \\\n -H "accept: application/json" \\\n -H "Content-Type: application/json" \\\n -u "admin:$(kubectl get secret harbor-admin-password -n harbor -o jsonpath="{.data.HARBOR_ADMIN_PASSWORD}" | base64 --decode)" \\\n -d "{\\"robot_name_prefix\\":\\"robot-\\"}"\n'})}),"\n",(0,a.jsx)(r.p,{children:"You can also do it via Harbor UI in the Configuration section."}),"\n",(0,a.jsx)(r.p,{children:"Then proceed to create a project and a robot user."}),"\n",(0,a.jsx)(r.p,{children:"In the end, use the following command to create a secret for the robot user in the k8s cluster."}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl create secret docker-registry regcred -n {namespace} --docker-server=harbor.${CLUSTER_DOMAIN} --docker-username=robot-{your robot name} --docker-password=<your-password>\n"})}),"\n",(0,a.jsx)(r.p,{children:"More on this in a dedicate section [TBD]."})]})}function d(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},8453:(e,r,s)=>{s.d(r,{R:()=>t,x:()=>c});var n=s(6540);const a={},o=n.createContext(a);function t(e){const r=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);