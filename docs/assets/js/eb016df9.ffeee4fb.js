"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[8318],{6210:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>i});const o=JSON.parse('{"id":"secret-management/openbao","title":"OpenBao","description":"The following setup may not be suitable for environments requiring the highest level of security, for example apps storing finance or healthcare data. For these environments you may want to use 3rd-party key management system, end to end encryption, etc. Please evaluate your security requirements carefully.","source":"@site/docs/60-secret-management/10-openbao.md","sourceDirName":"60-secret-management","slug":"/secret-management/openbao","permalink":"/nursery/secret-management/openbao","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/60-secret-management/10-openbao.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Traefik & Core DNS","permalink":"/nursery/ingress-and-ssl/traefik"},"next":{"title":"External Secrets","permalink":"/nursery/secret-management/external-secrets"}}');var t=a(4848),r=a(8453);const s={},c="OpenBao",l={},i=[{value:"Create namespace and unseal key",id:"create-namespace-and-unseal-key",level:2},{value:"Verify",id:"verify",level:3},{value:"Enable KV secrets engine",id:"enable-kv-secrets-engine",level:3},{value:"OpenBao UI",id:"openbao-ui",level:3},{value:"Keycloak OIDC Authentication",id:"keycloak-oidc-authentication",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"openbao",children:"OpenBao"})}),"\n",(0,t.jsx)(n.admonition,{type:"danger",children:(0,t.jsx)(n.p,{children:"The following setup may not be suitable for environments requiring the highest level of security, for example apps storing finance or healthcare data. For these environments you may want to use 3rd-party key management system, end to end encryption, etc. Please evaluate your security requirements carefully."})}),"\n",(0,t.jsxs)(n.p,{children:["Details at ",(0,t.jsx)(n.a,{href:"https://openbao.org/docs/platform/k8s/helm/",children:"https://openbao.org/docs/platform/k8s/helm/"})]}),"\n",(0,t.jsx)(n.h2,{id:"create-namespace-and-unseal-key",children:"Create namespace and unseal key"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl create namespace openbao\n"})}),"\n",(0,t.jsx)(n.p,{children:"Generate unseal key and create k8s secret."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"openssl rand -out openbao-unseal-1.key 32\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl create secret generic openbao-unseal-key -n openbao --from-file=openbao-unseal-1.key\n"})}),"\n",(0,t.jsx)(n.p,{children:"Store base64 encoded unseal key securely in Pulumi."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'pulumi --cwd $PULUMI_CWD config set --secret openbao:unsealKey1Base64 "$(cat openbao-unseal-1.key | base64)"\n'})}),"\n",(0,t.jsx)(n.p,{children:"Remove the local unseal key file."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"rm openbao-unseal-1.key\n"})}),"\n",(0,t.jsx)(n.p,{children:"Add OpenBao helm repo:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm repo add openbao https://openbao.github.io/openbao-helm\n"})}),"\n",(0,t.jsx)(n.p,{children:"Install OpenBao in the namespace:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm upgrade --install openbao openbao/openbao \\\r\n--version 0.19.1 \\\r\n--namespace openbao \\\r\n--values k8s/openbao/override-values.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Initialize OpenBao:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao operator init\n"})}),"\n",(0,t.jsx)(n.p,{children:"Store recovery keys. Replace the example keys between quotes below with the actual keys output from the above command."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'pulumi --cwd $PULUMI_CWD config set --secret openbao:recoveryKeys "Recovery Key 1: <your-recovery-key-1>\r\nRecovery Key 2: <your-recovery-key-2>\r\nRecovery Key 3: <your-recovery-key-3>\r\nRecovery Key 4: <your-recovery-key-4>\r\nRecovery Key 5: <your-recovery-key-5>"\n'})}),"\n",(0,t.jsx)(n.p,{children:"Store initial root token. Replace the example token between quotes below with the actual initial root token output from the init command."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'pulumi --cwd $PULUMI_CWD config set --secret openbao:initialRootToken "<your-initial-root-token>"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"verify",children:"Verify"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao login # Then use the root token\r\nkubectl exec -ti openbao-0 -n openbao -- bao operator raft list-peers\r\nkubectl exec -ti openbao-0 -n openbao -- bao operator raft autopilot state\n"})}),"\n",(0,t.jsx)(n.h3,{id:"enable-kv-secrets-engine",children:"Enable KV secrets engine"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao secrets enable -version=2 kv\n"})}),"\n",(0,t.jsx)(n.h3,{id:"openbao-ui",children:"OpenBao UI"}),"\n",(0,t.jsx)(n.p,{children:"Create OpenBao UI ingress:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"envsubst '$CLUSTER_DOMAIN' < k8s/openbao/openbao-ingress.yaml | kubectl apply -f -\n"})}),"\n",(0,t.jsx)(n.p,{children:"Run these commands to access OpenBao UI with initial root token:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'echo "OpenBao UI URL: https://openbao.${CLUSTER_DOMAIN}"\r\necho "Initial Root Token: $(pulumi --cwd $PULUMI_CWD config get openbao:initialRootToken)"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"keycloak-oidc-authentication",children:"Keycloak OIDC Authentication"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://openbao.org/docs/auth/jwt/oidc-providers/keycloak/",children:"https://openbao.org/docs/auth/jwt/oidc-providers/keycloak/"})}),"\n",(0,t.jsxs)(n.p,{children:["Create Client in Keycloak with the following settings. Replace ",(0,t.jsx)(n.code,{children:"<CLUSTER_DOMAIN>"})," with actual value."]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Setting"}),(0,t.jsx)(n.th,{children:"Value"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Client ID"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"openbao"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Root URL"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"https://openbao.<CLUSTER_DOMAIN>"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Redirect URIs"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"/ui/vault/auth/oidc/oidc/callback"})," ",(0,t.jsx)("br",{}),"  ",(0,t.jsx)(n.code,{children:"/v1/auth/oidc/*"})," ",(0,t.jsx)("br",{}),"  ",(0,t.jsx)(n.code,{children:"http://localhost:8250/oidc/callback"})]})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"Enable OIDC auth method in OpenBao:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao auth enable oidc\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Configure OIDC auth method in OpenBao. Replace ",(0,t.jsx)(n.code,{children:"<CLIENT_SECRET>"})," and ",(0,t.jsx)(n.code,{children:"<CLUSTER_DOMAIN>"})," with actual values."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'kubectl exec -ti openbao-0 -n openbao -- bao write auth/oidc/config \\\r\n  oidc_client_id="openbao" \\\r\n  oidc_client_secret="<CLIENT_SECRET>" \\\r\n  default_role="admin-sso" \\\r\n  oidc_discovery_url="https://account.<CLUSTER_DOMAIN>/realms/nursery"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Create OIDC role in OpenBao. Replace ",(0,t.jsx)(n.code,{children:"<CLUSTER_DOMAIN>"})," with actual value."]}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsx)(n.p,{children:'The example below allows any user in the "Nursery Admins" group in Keycloak to log in to OpenBao with admin privileges. Adjust the configuration according to your security requirements.'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'kubectl exec -ti openbao-0 -n openbao -- bao write auth/oidc/role/admin-sso - <<EOF\r\n{\r\n    "role_type": "oidc",\r\n    "user_claim": "email",\r\n    "token_policies": "admin,default",\r\n    "oidc_scopes": "profile,email",\r\n    "bound_claims": { "groups": ["/Nursery Admins"] },\r\n    "allowed_redirect_uris": "https://openbao.<CLUSTER_DOMAIN>/v1/auth/oidc/callback,https://openbao.<CLUSTER_DOMAIN>/ui/vault/auth/oidc/oidc/callback,http://localhost:8250/oidc/callback"\r\n}\r\nEOF\n'})}),"\n",(0,t.jsx)(n.p,{children:"Create admin policy in OpenBao that allows managing kv secrets:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'kubectl exec -ti openbao-0 -n openbao -- bao policy write admin - <<EOF\r\n# Allow a token to manage kv secrets\r\npath "kv/*" {\r\n    capabilities = ["create", "read", "update", "delete", "list"]\r\n}\r\nEOF\n'})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>s,x:()=>c});var o=a(6540);const t={},r=o.createContext(t);function s(e){const n=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);