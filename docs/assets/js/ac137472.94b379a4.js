"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[8953],{10:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>n,toc:()=>i});const n=JSON.parse('{"id":"cnpg/cluster_roles_and_secrets","title":"Cluster Roles & Secrets","description":"This page describes the database roles used by CloudNativePG and how to manage them.","source":"@site/docs/100-cnpg/10_cluster_roles_and_secrets.md","sourceDirName":"100-cnpg","slug":"/cnpg/cluster_roles_and_secrets","permalink":"/nursery/cnpg/cluster_roles_and_secrets","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/100-cnpg/10_cluster_roles_and_secrets.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Manage storage","permalink":"/nursery/storage/manage-storage"},"next":{"title":"Operator and Cluster","permalink":"/nursery/cnpg/operator_and_cluster"}}');var t=r(4848),a=r(8453);const o={},l="Cluster Roles & Secrets",c={},i=[{value:"Roles",id:"roles",level:2},{value:"External Secrets",id:"external-secrets",level:2}];function d(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"cluster-roles--secrets",children:"Cluster Roles & Secrets"})}),"\n",(0,t.jsx)(s.p,{children:"This page describes the database roles used by CloudNativePG and how to manage them."}),"\n",(0,t.jsx)(s.h2,{id:"roles",children:"Roles"}),"\n",(0,t.jsxs)(s.p,{children:["File ",(0,t.jsx)(s.code,{children:"/k8s/cnpg-system/cnpg-cluster-values.yaml"})," contains the following configuration for database roles."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"roles:\r\n    - name: <ROLE_NAME>\r\n        ensure: present # this field can be set to 'present' or 'absent' to create or delete the role respectively\r\n        login: true\r\n        superuser: false # this field can be set to true or false to grant or revoke superuser privileges\r\n        passwordSecret:\r\n            name: <ROLE_SECRET_NAME>\r\n    # START ENVIRONMENT SPECIFIC ROLES SECTION\r\n    # This section can be used to define additional roles specific to your environment. It will be preserved during updates.\r\n    - name: <ROLE_NAME>\r\n        ensure: present\r\n        login: true\r\n        superuser: false\r\n        passwordSecret:\r\n            name: <ROLE_SECRET_NAME>\r\n    # END ENVIRONMENT SPECIFIC ROLES SECTION\n"})}),"\n",(0,t.jsx)(s.p,{children:"By default the following roles are created:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"postgres"}),": This is the default superuser role created by PostgreSQL."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"keycloak"}),": This role is used by the Keycloak."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"harbor"}),": This role is used by the Harbor."]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"forgejo"}),": This role is used by the Forgejo."]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"You can add additional roles as needed here:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"# START ENVIRONMENT SPECIFIC ROLES SECTION\r\n...\r\n# END ENVIRONMENT SPECIFIC ROLES SECTION\n"})}),"\n",(0,t.jsx)(s.p,{children:"This section is preserved during updates, so you can safely add your custom roles there without worrying about them being overwritten. This is where you can add roles for your applications that need to access the database."}),"\n",(0,t.jsx)(s.h2,{id:"external-secrets",children:"External Secrets"}),"\n",(0,t.jsx)(s.p,{children:"Let's see how to create the secrets for the default roles. The process is the same for any additional roles you want to create."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao kv put -mount=kv cnpg-superuser-secret \\\r\n    username=postgres \\\r\n    password=$(openssl rand -base64 32)\n"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao kv put -mount=kv keycloak-db-credentials \\\r\n    username=keycloak \\\r\n    password=$(openssl rand -base64 32)\n"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao kv put -mount=kv harbor-db-credentials \\\r\n    username=harbor \\\r\n    password=$(openssl rand -base64 32)\n"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao kv put -mount=kv forgejo-db-credentials \\\r\n    username=forgejo \\\r\n    password=$(openssl rand -base64 32)\n"})}),"\n",(0,t.jsx)(s.p,{children:"After creating the secrets in OpenBao, you need to create the corresponding ExternalSecrets in Kubernetes to make them available to the CloudNativePG operator."}),"\n",(0,t.jsxs)(s.p,{children:["Start by creating the ",(0,t.jsx)(s.code,{children:"cnpg-system"})," namespace if it doesn't exist already."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl apply -f k8s/cnpg-system/cnpg-system-namespace.yaml\n"})}),"\n",(0,t.jsx)(s.p,{children:"Then apply the ExternalSecret manifests for each role."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl apply -f k8s/cnpg-system/cnpg-superuser-secret-external-secret.yaml\r\nkubectl apply -f k8s/cnpg-system/databases/keycloak/keycloak-db-credentials-external-secret.yaml\r\nkubectl apply -f k8s/cnpg-system/databases/harbor/harbor-db-credentials-external-secret.yaml\r\nkubectl apply -f k8s/cnpg-system/databases/forgejo/forgejo-db-credentials-external-secret.yaml\n"})}),"\n",(0,t.jsxs)(s.admonition,{type:"warning",children:[(0,t.jsx)(s.p,{children:"Every time you update the secrets in OpenBao, make sure they are properly synced to Kubernetes by checking the corresponding ExternalSecrets. The CloudNativePG operator relies on these secrets to manage the database roles and permissions, so it's crucial to keep them up to date."}),(0,t.jsxs)(s.p,{children:["Additionally everytime you update roles you need to reapply the cluster manifest to ensure the changes are picked up by the operator.\r\nFor more details see ",(0,t.jsx)(s.a,{href:"/nursery/cnpg/operator_and_cluster#cluster-setup",children:"Cluster setup"}),"."]})]})]})}function u(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,s,r)=>{r.d(s,{R:()=>o,x:()=>l});var n=r(6540);const t={},a=n.createContext(t);function o(e){const s=n.useContext(a);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),n.createElement(a.Provider,{value:s},e.children)}}}]);