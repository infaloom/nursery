"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[5334],{5678:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>a,default:()=>u,frontMatter:()=>c,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"disaster-recovery/cnpg-restore","title":"CloudNativePG restore","description":"As per the documentation https://cloudnative-pg.io/documentation/1.25/recovery/ CNPG restores from the S3 backup to a new read-only cluster.","source":"@site/docs/150-disaster-recovery/10-cnpg-restore.md","sourceDirName":"150-disaster-recovery","slug":"/disaster-recovery/cnpg-restore","permalink":"/nursery/disaster-recovery/cnpg-restore","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/150-disaster-recovery/10-cnpg-restore.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Woodpecker CI","permalink":"/nursery/woodpecker/"},"next":{"title":"Velero backups","permalink":"/nursery/disaster-recovery/velero-backups"}}');var s=r(4848),o=r(8453);const c={},a="CloudNativePG restore",i={},l=[{value:"Instance promotion",id:"instance-promotion",level:2},{value:"Clean up",id:"clean-up",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"cloudnativepg-restore",children:"CloudNativePG restore"})}),"\n",(0,s.jsxs)(n.p,{children:["As per the documentation ",(0,s.jsx)(n.a,{href:"https://cloudnative-pg.io/documentation/1.25/recovery/",children:"https://cloudnative-pg.io/documentation/1.25/recovery/"})," CNPG restores from the S3 backup to a new read-only cluster."]}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsxs)(n.p,{children:["The recovery cluster has backups disabled by default. You can enabled them in the values file.\r\nIf you enable backups. You MUST iterate on the backup bucket path on each recovery to avoid backup conflicts. ",(0,s.jsx)(n.code,{children:"backups.s3.path"}),": /v1, /v2, /v3, ..."]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"envsubst < k8s/cnpg-system/cnpg-recovery-cluster-values.yaml | \\\r\nhelm upgrade --install cnpg-recovery-cluster cnpg/cluster \\\r\n--version 0.2.1 \\\r\n--namespace cnpg-system \\\r\n--values -\n"})}),"\n",(0,s.jsx)(n.h2,{id:"instance-promotion",children:"Instance promotion"}),"\n",(0,s.jsx)(n.p,{children:"Check the status of the cluster by running the command"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl cnpg status cnpg-recovery-cluster -n cnpg-system\n"})}),"\n",(0,s.jsx)(n.p,{children:"Altough, documentation states that the is restored in read-only mode, my testing proves otherwise.\r\nAnyway, if the recovery cluster doesn't have an instance promoted to a primary you can promote an instance with the following command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl cnpg promote cnpg-recovery-cluster cnpg-recovery-cluster-1 -n cnpg-system\n"})}),"\n",(0,s.jsx)(n.h2,{id:"clean-up",children:"Clean up"}),"\n",(0,s.jsx)(n.p,{children:"Remove recovery cluster by uninstalling the chart"}),"\n",(0,s.jsx)(n.admonition,{type:"danger",children:(0,s.jsx)(n.p,{children:"This will remove the recovery cluster data as well, all PVCs will be removed."})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"helm uninstall cnpg-recovery-cluster -n cnpg-system\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>a});var t=r(6540);const s={},o=t.createContext(s);function c(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);