"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9772],{2926:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>n,toc:()=>i});const n=JSON.parse('{"id":"disaster-recovery/velero-backups","title":"Velero backups","description":"This section covers backing up k8s resources with corresponding data from PVCs. The purpose is backing up the whole namespaces for example.","source":"@site/docs/150-disaster-recovery/20-velero-backups.md","sourceDirName":"150-disaster-recovery","slug":"/disaster-recovery/velero-backups","permalink":"/nursery/disaster-recovery/velero-backups","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/150-disaster-recovery/20-velero-backups.md","tags":[],"version":"current","sidebarPosition":20,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"CloudNativePG restore","permalink":"/nursery/disaster-recovery/cnpg-restore"},"next":{"title":"MSSQL Server (dev/test only)","permalink":"/nursery/miscellaneous/mssql-server"}}');var a=s(4848),o=s(8453);const t={},l="Velero backups",c={},i=[{value:"Enabling Rook-Ceph snapshot support",id:"enabling-rook-ceph-snapshot-support",level:2},{value:"Velero s3 integration",id:"velero-s3-integration",level:2},{value:"Install Velero CLI",id:"install-velero-cli",level:3},{value:"Configure S3 storage",id:"configure-s3-storage",level:3},{value:"Install Velero server",id:"install-velero-server",level:3},{value:"Backup / Restore",id:"backup--restore",level:2}];function d(e){const r={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.header,{children:(0,a.jsx)(r.h1,{id:"velero-backups",children:"Velero backups"})}),"\n",(0,a.jsx)(r.p,{children:"This section covers backing up k8s resources with corresponding data from PVCs. The purpose is backing up the whole namespaces for example."}),"\n",(0,a.jsx)(r.h2,{id:"enabling-rook-ceph-snapshot-support",children:"Enabling Rook-Ceph snapshot support"}),"\n",(0,a.jsxs)(r.p,{children:["Official documentation:",(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.a,{href:"https://rook.io/docs/rook/v1.14/Storage-Configuration/Ceph-CSI/ceph-csi-snapshot/",children:"https://rook.io/docs/rook/v1.14/Storage-Configuration/Ceph-CSI/ceph-csi-snapshot/"})]}),"\n",(0,a.jsx)(r.p,{children:"Install k8s snapshot crds"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl kustomize https://github.com/kubernetes-csi/external-snapshotter/client/config/crd | kubectl create -f -\n"})}),"\n",(0,a.jsx)(r.p,{children:"Install snapshot controller"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl -n kube-system kustomize https://github.com/kubernetes-csi/external-snapshotter/deploy/kubernetes/snapshot-controller | kubectl create -f -\n"})}),"\n",(0,a.jsx)(r.p,{children:"Install rook-ceph VolumeSnapshotClass"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f https://github.com/rook/rook/raw/refs/heads/master/deploy/examples/csi/rbd/snapshotclass.yaml\n"})}),"\n",(0,a.jsx)(r.h2,{id:"velero-s3-integration",children:"Velero s3 integration"}),"\n",(0,a.jsxs)(r.p,{children:["Details at ",(0,a.jsx)(r.a,{href:"https://velero.io/docs/v1.17/contributions/minio/",children:"https://velero.io/docs/v1.17/contributions/minio/"})]}),"\n",(0,a.jsx)(r.h3,{id:"install-velero-cli",children:"Install Velero CLI"}),"\n",(0,a.jsx)(r.p,{children:"Download v1.17"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"wget https://github.com/vmware-tanzu/velero/releases/download/v1.17.0/velero-v1.17.0-linux-amd64.tar.gz\n"})}),"\n",(0,a.jsx)(r.p,{children:"Unpack"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"tar -xvf velero-v1.17.0-linux-amd64.tar.gz\n"})}),"\n",(0,a.jsx)(r.p,{children:"Move binary to path"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"sudo mv velero-v1.17.0-linux-amd64/velero /usr/local/bin/\n"})}),"\n",(0,a.jsx)(r.h3,{id:"configure-s3-storage",children:"Configure S3 storage"}),"\n",(0,a.jsx)(r.p,{children:"Create external secret for velero. Here I reuse the same S3 credentials as for cnpg backups."}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/velero/cloud-credentials-external-secret.yaml\n"})}),"\n",(0,a.jsxs)(r.p,{children:["Create ",(0,a.jsx)(r.code,{children:"velero"})," bucket at your S3 server."]}),"\n",(0,a.jsx)(r.p,{children:"Export S3_URL"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:'export S3_URL="<REPLACE_WITH_YOUR_S3_ENDPOINT_URL>"\n'})}),"\n",(0,a.jsx)(r.h3,{id:"install-velero-server",children:"Install Velero server"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:'velero install \\\n    --provider aws \\\n    --plugins velero/velero-plugin-for-aws:v1.13.0 \\\n    --bucket velero \\\n    --no-secret \\\n    --backup-location-config region=,s3ForcePathStyle="true",s3Url=${S3_URL} \\\n    --snapshot-location-config region=,s3ForcePathStyle="true",s3Url=${S3_URL} \\\n    --features EnableCSI \\\n    --use-node-agent \\\n    --node-agent-disable-host-path \\\n    --velero-pod-mem-limit 2048Mi\n'})}),"\n",(0,a.jsx)(r.admonition,{type:"note",children:(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.code,{children:"--velero-pod-mem-limit 2048Mi"})," is because backups sometimes fail because of limited pod resources. Default is 512Mi."]})}),"\n",(0,a.jsx)(r.p,{children:"Check version:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"velero version\n"})}),"\n",(0,a.jsx)(r.p,{children:"Expected output:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"Client:\n        Version: v1.17.0\n        Git commit: 3172d9f99c3d501aad9ddfac8176d783f7692dce\nServer:\n        Version: v1.17.0\n"})}),"\n",(0,a.jsx)(r.h2,{id:"backup--restore",children:"Backup / Restore"}),"\n",(0,a.jsx)(r.p,{children:"Run test backup"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"velero backup create whoami-backup \\\n  --include-namespaces whoami \\\n  --snapshot-move-data \\\n  --exclude-resources orders.acme.cert-manager.io,challenges.acme.cert-manager.io,certificaterequests.cert-manager.io\n"})}),"\n",(0,a.jsx)(r.p,{children:"Display logs"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"velero backup logs whoami-backup\n"})}),"\n",(0,a.jsx)(r.p,{children:"Delete the namespace before restoring:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"kubectl delete namespace whoami\n"})}),"\n",(0,a.jsx)(r.p,{children:"Restore everything except certificates and wait for the certificates to be recreated:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"velero restore create whoami-restore-no-certs \\\n  --from-backup whoami-backup \\\n  --exclude-resources certificates.cert-manager.io\n"})}),"\n",(0,a.jsx)(r.p,{children:"After the auto-generated certificates are created, restore any remaining certificates:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"velero restore create whoami-restore \\\n  --from-backup whoami-backup\n"})}),"\n",(0,a.jsx)(r.p,{children:"Verify that everything is working fine."}),"\n",(0,a.jsx)(r.p,{children:"Cleanup"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"velero restore delete whoami-restore-no-certs; \\\nvelero restore delete whoami-restore; \\\nvelero backup delete whoami-backup\n"})})]})}function h(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,r,s)=>{s.d(r,{R:()=>t,x:()=>l});var n=s(6540);const a={},o=n.createContext(a);function t(e){const r=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);