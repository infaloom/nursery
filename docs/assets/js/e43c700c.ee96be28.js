"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[3676],{3022:(e,r,a)=>{a.r(r),a.d(r,{assets:()=>i,contentTitle:()=>c,default:()=>d,frontMatter:()=>t,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"harbor/harbor-setup","title":"Harbor Setup","description":"https://goharbor.io/","source":"@site/docs/120-harbor/10-harbor-setup.md","sourceDirName":"120-harbor","slug":"/harbor/harbor-setup","permalink":"/nursery/harbor/harbor-setup","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/120-harbor/10-harbor-setup.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Redis","permalink":"/nursery/redis/"},"next":{"title":"Harbor SSO","permalink":"/nursery/harbor/harbor-sso"}}');var s=a(4848),o=a(8453);const t={},c="Harbor Setup",i={},l=[{value:"Create external secrets",id:"create-external-secrets",level:2},{value:"Install",id:"install",level:2},{value:"Accessing Harbor",id:"accessing-harbor",level:2},{value:"Pulling an image from the registry",id:"pulling-an-image-from-the-registry",level:2}];function h(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"harbor-setup",children:"Harbor Setup"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.a,{href:"https://goharbor.io/",children:"https://goharbor.io/"})}),"\n",(0,s.jsx)(r.p,{children:"Harbor is an open-source container image registry that secures images with role-based access control, scans images for vulnerabilities, signs images as trusted, etc."}),"\n",(0,s.jsx)(r.h2,{id:"create-external-secrets",children:"Create external secrets"}),"\n",(0,s.jsx)(r.p,{children:"Create OpenBao secret with a random password for Harbor admin user"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao kv put -mount=kv harbor-admin-password \\\r\n    HARBOR_ADMIN_PASSWORD=$(openssl rand -base64 32)\n"})}),"\n",(0,s.jsx)(r.p,{children:"Create OpenBao secret with a random password for Harbor db user"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl exec -ti openbao-0 -n openbao -- bao kv put -mount=kv harbor-db-credentials \\\r\n    username=harbor \\\r\n    password=$(openssl rand -base64 32)\n"})}),"\n",(0,s.jsx)(r.p,{children:"Create namespace"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl create namespace harbor\n"})}),"\n",(0,s.jsx)(r.p,{children:"Create ExternalSecret to pull the admin password"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/harbor/harbor-admin-password-external-secret.yaml\n"})}),"\n",(0,s.jsx)(r.p,{children:"Create ExternalSecret to pull the Harbor db credentials into harbor namespace"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/harbor/harbor-db-credentials-external-secret.yaml\n"})}),"\n",(0,s.jsx)(r.p,{children:"Ensure you already have External Secret to pull the Harbor db credentials into cnpg-system namespace. This should have been created with the cnpg cluster."}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/cnpg-system/databases/harbor/harbor-db-credentials-external-secret.yaml\n"})}),"\n",(0,s.jsx)(r.h2,{id:"install",children:"Install"}),"\n",(0,s.jsxs)(r.p,{children:["By default the harbor is configured to be served from ",(0,s.jsx)(r.code,{children:"https://harbor.${CLUSTER_DOMAIN}"})," but you can change it in the ",(0,s.jsx)(r.code,{children:"k8s/harbor/values.yaml"})," file."]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"export CLUSTER_DOMAIN=$(pulumi --cwd $PULUMI_CWD config get cluster:domain)\n"})}),"\n",(0,s.jsx)(r.p,{children:"It will be accessable from the ssh source IP address you set in the pulumi config."}),"\n",(0,s.jsx)(r.admonition,{type:"warning",children:(0,s.jsx)(r.p,{children:"Harbor has issues with Redis Sentinel support at the time of writing.\r\nWe are using the Harbor helm chart built-in redis instance."})}),"\n",(0,s.jsx)(r.admonition,{type:"info",children:(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"harbor"})," role should have been created with the cnpg cluster."]})}),"\n",(0,s.jsxs)(r.p,{children:["Create ",(0,s.jsx)(r.code,{children:"harbor"})," database in the PostgreSQL cluster"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/cnpg-system/databases/harbor/harbor-database.yaml\n"})}),"\n",(0,s.jsx)(r.p,{children:"Add helm repo"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"helm repo add harbor https://helm.goharbor.io\n"})}),"\n",(0,s.jsx)(r.p,{children:"Install Harbor with Helm"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"envsubst < k8s/harbor/harbor-values.yaml | \\\r\nhelm upgrade --install harbor harbor/harbor \\\r\n--version 1.16.2 \\\r\n--namespace harbor --create-namespace \\\r\n--values -\n"})}),"\n",(0,s.jsx)(r.h2,{id:"accessing-harbor",children:"Accessing Harbor"}),"\n",(0,s.jsx)(r.p,{children:"Run the following to get instructions to access Harbor UI"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'echo "---- Harbor Access Instructions ----"\r\necho "Harbor url: https://$(kubectl --namespace harbor get ingress harbor-ingress -n harbor -o jsonpath=\'{.spec.rules[0].host}\')"\r\necho "Username: admin"\r\necho "Password: $(kubectl get secret harbor-admin-password -n harbor -o jsonpath="{.data.HARBOR_ADMIN_PASSWORD}" | base64 --decode)"\r\necho "------------------------------------"\n'})}),"\n",(0,s.jsx)(r.h2,{id:"pulling-an-image-from-the-registry",children:"Pulling an image from the registry"}),"\n",(0,s.jsxs)(r.p,{children:["Update the robot prefix to ",(0,s.jsx)(r.code,{children:"robot-"})," to avoid bash issues with ",(0,s.jsx)(r.code,{children:"robot$"})," using the harbor API:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'curl -X PUT "https://harbor.${CLUSTER_DOMAIN}/api/v2.0/configurations" \\\r\n -H "accept: application/json" \\\r\n -H "Content-Type: application/json" \\\r\n -u "admin:$(kubectl get secret harbor-admin-password -n harbor -o jsonpath="{.data.HARBOR_ADMIN_PASSWORD}" | base64 --decode)" \\\r\n -d "{\\"robot_name_prefix\\":\\"robot-\\"}"\n'})}),"\n",(0,s.jsx)(r.p,{children:"You can also do it via Harbor UI in the Configuration section."}),"\n",(0,s.jsx)(r.p,{children:"Then proceed to create a project and a robot user."}),"\n",(0,s.jsx)(r.p,{children:"In the end, use the following command to create a secret for the robot user in the k8s cluster."}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl create secret docker-registry regcred -n {namespace} --docker-server=harbor.${CLUSTER_DOMAIN} --docker-username=robot-{your robot name} --docker-password=<your-password>\n"})}),"\n",(0,s.jsx)(r.p,{children:"More on this in a dedicate section [TBD]."})]})}function d(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8453:(e,r,a)=>{a.d(r,{R:()=>t,x:()=>c});var n=a(6540);const s={},o=n.createContext(s);function t(e){const r=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);