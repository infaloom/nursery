"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[1834],{892:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"expose-services/index","title":"Expose Services","description":"In this chapter, we will learn how to expose TCP services running in a Kubernetes cluster to the outside world in a secure manner.","source":"@site/docs/135-expose-services/index.md","sourceDirName":"135-expose-services","slug":"/expose-services/","permalink":"/nursery/expose-services/","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/135-expose-services/index.md","tags":[],"version":"current","frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Woodpecker CI","permalink":"/nursery/woodpecker/"},"next":{"title":"Monitoring","permalink":"/nursery/observability/monitoring/"}}');var t=s(4848),o=s(8453);const a={},i="Expose Services",c={},l=[];function d(e){const r={a:"a",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"expose-services",children:"Expose Services"})}),"\n",(0,t.jsx)(r.p,{children:"In this chapter, we will learn how to expose TCP services running in a Kubernetes cluster to the outside world in a secure manner."}),"\n",(0,t.jsxs)(r.p,{children:["While HTTP/HTTPS services can be exposed using Ingress, there are TCP services that require different approach. Until Hetzner LB starts supporting firewall rules, this is the most efficient way I found to expose TCP services while ensuring security. ",(0,t.jsx)(r.a,{href:"https://docs.hetzner.com/cloud/firewalls/faq#can-firewalls-be-applied-to-my-hetzner-cloud-load-balancers",children:"Learn More"})]}),"\n",(0,t.jsx)(r.p,{children:"We are creating a HAProxy daemon set that runs on each node and forwards traffic to the appropriate service. This way, we can expose any TCP service without needing to configure Ingress or load balancers. The daemon set will listen on a specific port and forward traffic to the service running in the cluster."}),"\n",(0,t.jsxs)(r.p,{children:["First export the source IP what will be allowed to access the service as an environment variable. I'm using the already defined ",(0,t.jsx)(r.code,{children:"SSH_SOURCE_IP"})," variable that contains the IP address of my HQ, but you can replace it with any IP address you want to allow access to the services."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"export HQ_IP=$SSH_SOURCE_IP\n"})}),"\n",(0,t.jsx)(r.p,{children:"Create namespace for the TCP proxy:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/tcp-proxy/tcp-proxy-namespace.yaml\n"})}),"\n",(0,t.jsx)(r.p,{children:"Then create a ConfigMap for HAProxy with the following content:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"envsubst '$HQ_IP' < k8s/tcp-proxy/haproxy-cfg-configmap.yaml | kubectl apply -f -\n"})}),"\n",(0,t.jsx)(r.p,{children:"Finally, create the HAProxy daemon set:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f k8s/tcp-proxy/tcp-haproxy-daemonset.yaml\n"})}),"\n",(0,t.jsx)(r.p,{children:"With this setup, you can safely expose any TCP service on load balancer by adding the appropriate frontend and backend configuration to the HAProxy ConfigMap. The provided ConfigMap is for exposing:"}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Service"}),(0,t.jsx)(r.th,{children:"Port"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Forgejo git SSH service"}),(0,t.jsx)(r.td,{children:"22"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"PostgreSQL CNPG cluster"}),(0,t.jsx)(r.td,{children:"5432"})]})]})]})]})}function h(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,r,s)=>{s.d(r,{R:()=>a,x:()=>i});var n=s(6540);const t={},o=n.createContext(t);function a(e){const r=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);