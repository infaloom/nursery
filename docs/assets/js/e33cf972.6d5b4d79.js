"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[4209],{6100:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"k3s/access-cluster","title":"Access the K3s cluster","description":"Control plane high availability","source":"@site/docs/40-k3s/40-access-cluster.md","sourceDirName":"40-k3s","slug":"/k3s/access-cluster","permalink":"/nursery/k3s/access-cluster","draft":false,"unlisted":false,"editUrl":"https://github.com/infaloom/nursery/tree/main/docusaurus/docs/40-k3s/40-access-cluster.md","tags":[],"version":"current","sidebarPosition":40,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Install K3s","permalink":"/nursery/k3s/install-k3s"},"next":{"title":"Load balancer DNS","permalink":"/nursery/ingress-and-ssl/load-balancer-dns"}}');var t=s(4848),i=s(8453);const o={},a="Access the K3s cluster",l={},c=[{value:"Control plane high availability",id:"control-plane-high-availability",level:2},{value:"Get kubeconfig from the server",id:"get-kubeconfig-from-the-server",level:2},{value:"Configure DNS",id:"configure-dns",level:2},{value:"Configure local kubectl",id:"configure-local-kubectl",level:2},{value:"Verify the cluster is working",id:"verify-the-cluster-is-working",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"access-the-k3s-cluster",children:"Access the K3s cluster"})}),"\n",(0,t.jsx)(n.h2,{id:"control-plane-high-availability",children:"Control plane high availability"}),"\n",(0,t.jsx)(n.p,{children:"To ensure high availability of the Kubernetes control plane, we will set up a load balancer using HAProxy on a separate server (serverLb) that will distribute traffic to the K3s server nodes."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ansible-playbook -i ./ansible/inventory.yaml ./ansible/playbooks/105_install_haproxy.yaml\n"})}),"\n",(0,t.jsx)(n.h2,{id:"get-kubeconfig-from-the-server",children:"Get kubeconfig from the server"}),"\n",(0,t.jsxs)(n.p,{children:["Copy kube config from server1. You run this command ",(0,t.jsx)(n.strong,{children:"ONCE"})," during the initial setup."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mkdir -p ~/.kube\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"scp root@$(pulumi --cwd $PULUMI_CWD stack output server1.Ipv4Address):/etc/rancher/k3s/k3s.yaml ~/.kube/config-pulumi-hetzner-k3s\n"})}),"\n",(0,t.jsx)(n.h2,{id:"configure-dns",children:"Configure DNS"}),"\n",(0,t.jsx)(n.p,{children:"Execute the following command for instructions to point your DNS to the server load balancer IP"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'echo "Point your $K8S_URL DNS record to $(pulumi --cwd $PULUMI_CWD stack output serverLb.Ipv4Address) IP address"\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"Note that the wildcard DNS record won't work in this case because wildcard DNS points to the main load balancer IP which is used for HTTP/HTTPS traffic. Kube API server uses a different port (6443) which is handled by the server load balancer."})}),"\n",(0,t.jsx)(n.p,{children:"Replace the server url in the kubeconfig file"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sed -i "s#https://127.0.0.1:6443#https://${K8S_URL}:6443#g" ~/.kube/config-pulumi-hetzner-k3s\n'})}),"\n",(0,t.jsx)(n.h2,{id:"configure-local-kubectl",children:"Configure local kubectl"}),"\n",(0,t.jsxs)(n.p,{children:["Export ",(0,t.jsx)(n.code,{children:"KUBECONFIG"})," env variable to point to the above config file."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"export KUBECONFIG=~/.kube/config-pulumi-hetzner-k3s\n"})}),"\n",(0,t.jsxs)(n.admonition,{type:"note",children:[(0,t.jsxs)(n.p,{children:["Optionally, you can rename the file to ",(0,t.jsx)(n.code,{children:"config"})," and place it in ",(0,t.jsx)(n.code,{children:"~/.kube/"})," directory. This way you don't need to export ",(0,t.jsx)(n.code,{children:"KUBECONFIG"})," env variable."]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mv ~/.kube/config-pulumi-hetzner-k3s ~/.kube/config\n"})})]}),"\n",(0,t.jsx)(n.h2,{id:"verify-the-cluster-is-working",children:"Verify the cluster is working"}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsx)(n.p,{children:"If at any point a pod gets stuck in ImagePullBackOff state it is most likely because the server's IP is blacklisted. Try deleting the affected pods and let them try to pull from the internal registry mirror."})}),"\n",(0,t.jsxs)(n.admonition,{type:"warning",children:[(0,t.jsxs)(n.p,{children:["Some resources take a while to start. Be patient and wait for the resources to stabilize.\nAs a rule of a thumb you can wait for all pods to become ready by executing the following command\nby replacing ",(0,t.jsx)(n.code,{children:"{deployment_namespace}"})," with the namespace of the deployment.\n",(0,t.jsx)(n.code,{children:"kubectl wait --for=condition=Ready pod --all -n {deployment_namespace} --timeout=60s"})]}),(0,t.jsxs)(n.p,{children:["For example, to wait for all pods in the ",(0,t.jsx)(n.code,{children:"loki"})," namespace to become ready you would run:\n",(0,t.jsx)(n.code,{children:"kubectl wait --for=condition=Ready pod --all -n loki --timeout=60s"})]}),(0,t.jsxs)(n.p,{children:["In addition, I recommend having ",(0,t.jsx)(n.a,{href:"https://k9scli.io/",children:"k9s"})," tool where you can easily view all pods in all namespaces or a very popular desktop GUI k8s management app ",(0,t.jsx)(n.a,{href:"https://k8slens.dev/",children:"Lens"}),"."]})]}),"\n",(0,t.jsx)(n.p,{children:"Ensure you are pointing to the correct cluster"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl get node\n"})}),"\n",(0,t.jsx)(n.p,{children:"The output should be similar to:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"NAME      STATUS   ROLES                       AGE    VERSION\nagent1    Ready    <none>                      228d   v1.32.3+k3s1\nagent2    Ready    <none>                      228d   v1.32.3+k3s1\nagent3    Ready    <none>                      228d   v1.32.3+k3s1\nserver1   Ready    control-plane,etcd,master   228d   v1.32.3+k3s1\nserver2   Ready    control-plane,etcd,master   228d   v1.32.3+k3s1\nserver3   Ready    control-plane,etcd,master   228d   v1.32.3+k3s1\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var r=s(6540);const t={},i=r.createContext(t);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);